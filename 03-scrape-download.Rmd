---
title: "README - Scrape & Download Cannabis Data"
author: "Martin Frigaard"
date: "current version: `r Sys.Date()`"
output: github_document
---


```{r setup, include=FALSE}
library(knitr)
library(rmdformats)
require(tidyverse)
library(plotly)
require(janitor)
require(skimr)
library(mosaic)
library(inspectdf)
library(visdat)
library(DT)
library(hrbrthemes)
# base options ----
base::options(
  tibble.print_max = 25,
  tibble.width = 78,
  scipen = 100000000,
  max.print = 999999
)
# knitr chunk options ----
knitr::opts_chunk$set(
  echo = TRUE, # show/hide all code
  # results = "hide", # hide results
  tidy = FALSE, # cleaner code printing
  comment = "#> ", # better console printing
  eval = TRUE, # turn this to FALSE stop code chunks from running
  message = TRUE, # show messages
  fig.width = 7, # figure width
  fig.height = 5, # figure height
  warning = FALSE, # show warnings
  size = "small", # size of the text
  fig.path = "figs/"
) # location of files
# knitr knit settings ----
knitr::opts_knit$set(
  width = 78
)
# theme -----
ggplot2::theme_set(hrbrthemes::theme_ipsum_tw(
  base_family = "DroidSansMono",
  base_size = 10,
  strip_text_size = 9,
  plot_title_family = "TitilliumWeb-SemiBold",
  plot_title_size = 20,
  axis_title_family = "Ubuntu",
  axis_title_size = 13
))
```


## Cannabis web data

We need a rich data source of cannabis products and their prices. We can get that by scraping some data from a webpage like [dutchie](https://dutchie.com/home).

Resources: 

- [Web Scraping Product Data in R with rvest and purrr](https://www.business-science.io/code-tools/2019/10/07/rvest-web-scraping.html) 

- [web scraping with rvest](https://www.datacamp.com/community/tutorials/r-web-scraping-rvest)

- [easy web scraping with R](https://blog.rstudio.com/2014/11/24/rvest-easy-web-scraping-with-r/)

- [R tutorial web scraping](https://tutorials.datasciencedojo.com/r-tutorial-web-scraping-rvest/)

- [Free code camp](https://www.freecodecamp.org/news/an-introduction-to-web-scraping-using-r-40284110c848/)



This document covers how to scrape the `dutchie` website using R. 

## The website

Scrape this website: [dutchie: Order Marijuana Online for Delivery or Pickup](https://dutchie.com/store/nectar-gresham/menu?).

### 1) Check `robots.txt` 

When I try the `https://dutchie.com/robots.txt`, I see this:

`Cannot GET /robots.txt`



### 2) Packages 

```{r packages, message=FALSE, warning=FALSE}
# Load libraries
library(rvest)     # HTML Hacking & Web Scraping
library(jsonlite)  # JSON manipulation
library(tidyverse) # Data Manipulation
library(tidyquant) # ggplot2 theme
library(xopen)     # Opens URL in Browser
library(knitr)     # Pretty HTML Tables
```

### 3) Store URL for all items

This is the URL for all the items in the Gresham store:

`https://dutchie.com/store/nectar-gresham/menu?show=All`

Store this in `dutchie_url`

```{r dutchie_url}
# URL to View All Products
dutchie_url <- "https://dutchie.com/store/nectar-gresham/menu?show=All"
# This will open the `dutchie_url`
# View URL in Browser
# xopen(dutchie_url)
```


### 4) Read HTML

This will read the html from the URL and store it in the `dutchie_html` object. 

```{r create-dutchie_html}
# Read HTML from URL 
dutchie_html <- xml2::read_html(x = dutchie_url)
dutchie_html %>% str()
```

This is an `xml_document` and `xml_node`. The data that are in the website have now been converted into something we can search with 

### 5) Find the Raw Data  

The Chrome DevTools shows the following: 

```{r 01-duchie-product.png, echo=FALSE}
# fs::dir_ls("figs")
knitr::include_graphics(path = "figs/01.1-duchie-product-container.png")
```

## Products container

Here is the `products-container`:

```html
<div id="products-container" class="sc-bdVaJa sc-bwzfXH menu__GridContainer-sc-1rs5xh0-2 nUSyV">
<div>
<div class="products-grid__ProductGroup-wiekrm-1 bgHopz">
<div class="products-grid__ProductGroupTitle-wiekrm-2 bqogUu"> 
Specials</div>
<div class="products-grid__ProductCardGrid-wiekrm-0 dgxldW">
<div class="consumer-product-card__InViewContainer-ncbvk2-0 fPZPyi">
<a href="/store/nectar-gresham/menu/5d48766e918c1600048a6adf">
<div class="product-card__Container-jns2-0 kOmnHp">
<div class="product-card__Content-jns2-1 xjcNp">
<div class="product-information__Container-m4y3za-0 KMfFk">
```

Below I try to get the `html_nodes()` from the `div class=` or `id`.

```{r selector-gadget-dgxldW, echo=FALSE}
knitr::include_graphics("figs/01-selector-gadget-dgxldW.png")
```

Trying the `html_nodes()` function here. 

```{r check-products-container}
dutchie_html %>% 
    rvest::html_nodes(".dgxldW")
```

```{r}
dutchie_html %>% 
    rvest::html_nodes(".xjcNp")
dutchie_html %>% 
    rvest::html_nodes(".bRofoH")
```


```{r}
dutchie_html %>%
    rvest::html_nodes(".products-grid__ProductGroup-wiekrm-1 bgHopz")

dutchie_html %>%
    rvest::html_nodes(".products-grid__ProductGroupTitle-wiekrm-2 bqogUu")
```

Try the Product Card Grid.

```{r 01.2-duchie-products-grid__ProductCardGrid.png, echo=FALSE}
# fs::dir_ls("figs")
knitr::include_graphics(
    path = "figs/01.2-duchie-products-grid__ProductCardGrid.png")
```

```{r grid__ProductCardGrid}
dutchie_html %>%
    rvest::html_nodes(".products-grid__ProductCardGrid-wiekrm-0 dgxldW")
```

And finally we check the Inview Container. 

```{r 01.3-duchie-consumer-product-card__InViewContainer.png, echo=FALSE}
# fs::dir_ls("figs")
knitr::include_graphics(
    path = "figs/01.3-duchie-consumer-product-card__InViewContainer.png")
```

Next we try the following `class` ids. 

```{r product-card-2}
dutchie_html %>%
    rvest::html_nodes(".consumer-product-card__InViewContainer-ncbvk2-0 fPZPyi")

dutchie_html %>%
    rvest::html_nodes(".product-card__Container-jns2-0 kOmnHp")

dutchie_html %>%
    rvest::html_nodes(".product-card__Content-jns2-1 xjcNp")

dutchie_html %>%
    rvest::html_nodes("product-information__Container-m4y3za-0 KMfFk")
```

No luck so far.




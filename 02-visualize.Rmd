---
title: "Part 2 - Visualize Cannabis Data"
author: "Martin Frigaard"
date: "current version: `r Sys.Date()`"
output: github_document
---


```{r setup, include=FALSE}
require(knitr)
require(rmdformats)
require(tidyverse)
require(plotly)
require(janitor)
require(skimr)
require(mosaic)
require(inspectdf)
require(visdat)
require(DT)
require(hrbrthemes)
# base options ----
base::options(
  tibble.print_max = 25,
  tibble.width = 78,
  scipen = 100000000,
  max.print = 999999,
  str = strOptions(
      strict.width = "wrap", 
      vec.len = 3, 
      drop.deparse.attr = TRUE)
)
# knitr chunk options ----
knitr::opts_chunk$set(
  echo = TRUE, # show/hide all code
  # results = "hide", # hide results
  tidy = FALSE, # cleaner code printing
  comment = "#> ", # better console printing
  eval = TRUE, # turn this to FALSE stop code chunks from running
  fig.width = 9, # figure width
  fig.height = 6.5, # figure height
  warning = FALSE, # show warnings
  message = FALSE,
  size = "small", # size of the text
  fig.path = "figs/"  # location of files
)
# knitr knit settings ----
knitr::opts_knit$set(
  width = 78
)
```

## Load the packages

These are the packages we will use to visualize the cannabis data. 

```{r package, message=FALSE, warning=FALSE}
library(readr)
library(tidyverse)
library(lubridate)
library(ggthemes)
library(cluster)
library(factoextra)
library(textshape)
library(knitr)
library(rmdformats)
library(plotly)
require(janitor)
require(skimr)
library(mosaic)
library(inspectdf)
library(visdat)
library(DT)
library(hrbrthemes)
```

## Import data 

This data came from a UK e-commerce dataset from the [UCI Machine Learning Laboratory](https://archive.ics.uci.edu/ml/datasets/online+retail) and the [kushy cannabis data set](https://github.com/kushyapp/cannabis-dataset). 

```{r import-CannabisWowData, message=FALSE, warning=FALSE}
# fs::dir_tree("data/processed/")
CannabisWowData <- read_csv("data/processed/2020-03-19-CannabisWowData.csv")
```

```{r check-glimpse}
CanData <- CannabisWowData %>% 
  # remove product data
  dplyr::select(-dplyr::contains("prod")) 
CanData %>% dplyr::glimpse(78)
```

This `data.frame` is a combination of some sales data with some product and brand data. 


### Set the graph theme

I like to use the `hrbrthemes::theme_ipsum_rc()`

```{r theme-for-bar-graphs}
# set theme
ggplot2::theme_set(hrbrthemes::theme_ipsum_rc(
  base_size = 11,
  strip_text_size = 12,
  axis_title_size = 14,
  plot_title_size = 21,
  subtitle_size = 18
))
```


## Most common brand categories 

These are the most common brands categories. 

```{r visualize-brand_category}
CanData %>% 
  dplyr::count(brand_category, sort = TRUE) %>% 
  utils::head(5) %>% 
  dplyr::mutate(brand_category = reorder(brand_category, n)) %>%
  ggplot2::ggplot(aes(x = brand_category, y = n)) +
    ggplot2::geom_col(aes(fill = brand_category), 
                      show.legend = FALSE) +
    ggplot2::labs(x = "Brand Category",
                  y = "Count",
                  title = "Top 10 Cannabis Brand Categories") +
    ggplot2::coord_flip()
```

This tells me there are 17 different categories for brands, and `Concentrates` are the most common brand category. I can also see `Flower` and `Edibles` are numbers two and three. 

## Most common product categories 

These are the most common product categories, sorted with the most common first. 

```{r visualize-product_category}
CanData %>% 
  dplyr::count(brand) %>%
  utils::head(10) %>% 
  dplyr::mutate(brand = reorder(brand, n)) %>%
  ggplot2::ggplot(aes(x = brand, y = n)) +
    ggplot2::geom_col(aes(fill = brand), 
                      show.legend = FALSE) +
    ggplot2::labs(x = "Brands",
                  y = "Count",
                  title = "Top 20 Cannabis Brands") +
    ggplot2::coord_flip()
```

## Most common brand & brand categories

Now we can group these two varibles and count them both, limniting this to the top 50. 

```{r top50-brand-categories}
Top50Data <- CanData %>% 
  dplyr::count(brand, brand_category) %>%
  dplyr::arrange(desc(n)) %>% 
  dplyr::rename(brand_cat_count = n) %>% 
  dplyr::filter(brand_category %in% c("Concentrates", "Edibles", 
                                      "Flower", "Medical")) %>% 
  utils::head(50) %>% 
  dplyr::mutate(brand = reorder(brand, brand_cat_count)) 

# Top50Data

Top50Data %>%
  ggplot2::ggplot(aes(x = brand, 
                      y = brand_cat_count, 
                      group = brand_category)) +
    ggplot2::geom_col(aes(fill = brand), 
                      show.legend = FALSE) +
    ggplot2::labs(x = "Brands",
                  y = "Count",
                  title = "Top 50 Cannabis Brands & Categories") +
    ggplot2::coord_flip() + 
    facet_wrap(. ~ brand_category, 
               scales = "free")
```


```{r GroupedCanData}
library(highcharter)
library(viridisLite)
library(treemap)

thm <- 
  hc_theme(
    colors = c("#1a6ecc", "#434348", "#90ed7d"),
    chart = list(
      backgroundColor = "transparent",
      style = list(fontFamily = "Ubuntu")
    ),
    xAxis = list(
      gridLineWidth = 1
    )
  )

GroupedCanData <- CanData %>%
  dplyr::group_by(brand_category, quantity) %>% 
  dplyr::summarise(sales_by_cat = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::sample_n(100)
# GroupedCanData

highcharter::hctreemap2(GroupedCanData, 
              group_vars = c("brand_category"),
              size_var = "sales_by_cat", 
              color_var = "sales_by_cat",
              layoutAlgorithm = "squarified",
              levelIsConstant = FALSE,
              allowDrillToNode = TRUE,
              palette = rev(viridis(6))) %>% 
  hc_add_theme(thm)
```


## Creating week over week data 

The code below creates a data.frame that is 'week-over-week', which is not an uncommon way of reporting sales data. 

```{r WeekOverWeek}
WeekOverWeek <- CanData %>%
    # get the week_year by quantity
  select(week_year, quantity) %>%
    # group these data
  group_by(week_year) %>%
    # summarize the data by weekly quantity
  summarize(week_qty = sum(quantity)) %>%
    # This introduces the lag function, 
    # Compute a lagged version of a time series, shifting the time base 
    # back by a given number of observations.
  mutate(prev_week = lag(week_qty, 1)) %>%
    # now we get the ratio of the difference between the weekly quantity and 
    # the previous week, and we divide that by the previous week.
  mutate(wow_quantity = (week_qty - prev_week) / prev_week) %>%
    # now we calculate the month, using week_year, abbreviations, and labels
  mutate(month = month(week_year, abbr = TRUE, label = TRUE)) %>%
    # and we group this final data set by the week_year variable
  group_by(week_year)
# check this data set
WeekOverWeek %>% dplyr::glimpse(78)
```

Here we see there is a data.frame with 52 rows (one for each week). And this data set is still grouped, but that won't be an issue.

## Plot annual sales (by week)

First we will reset the graph theme to a little smaller font to allow the dates to show up on the x-axis. 

```{r adjust-theme-for-line-charts}
# set theme
ggplot2::theme_set(hrbrthemes::theme_ipsum_rc(
  base_size = 10,
  strip_text_size = 11,
  axis_title_size = 9,
  plot_title_size = 15,
  subtitle_size = 13
))
```


## Week over week annual Sales

These are the week over week annual sales (quantity), faceted by month. 

```{r ggWoWAnnualSales}
  # these are the labels
labs_wow_annual_sales <- ggplot2::labs(
  y = 'Sales', 
  x = 'Week', 
  title = 'Week Over Week Annual Sales',
  subtitle = "Simulated Cannabis Sales Data",
  caption = "Graphic and analysis by PDG") 

WeekOverWeek %>% 
  
  tidyr::drop_na() %>% 
  
            dplyr::filter(.data = ., 
                          
                          month %in% c("Apr", "May", "Jun")) %>% 
  # this will put week_year on the x
    ggplot2::ggplot(aes(x = week_year, 
                        # and the week over week quantity on the y
                        y = wow_quantity)) +
  # add the line plot
    ggplot2::geom_line() +
  # and the point
    ggplot2::geom_point() +
  # the axis title here will inherit the size and color
    ggplot2::theme(axis.title = element_text(face = c("bold"))) +
  # this will remove the legend
    ggplot2::theme(legend.title = element_blank()) +
  # this adds the percent on the y axis
    ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 1),) +
  # here we facet by the month
    ggplot2::facet_wrap(. ~ month, 
                        # 
                        scales = "free") + 
    ggplot2::theme(axis.text.x = 
                     element_text(angle = 45, 
                                  hjust = 0.5, 
                                  vjust = 0.5)) +
  labs_wow_annual_sales
```

This shows some missing data in December, and a lot of variation in the sales from month to month. 

### Week over week invoice amount

This will give the user a categorical variable to filter the week over week sales by the amount per invoice.  

```{r WowAmntPerInvoice}
WowAmntPerInvoice <- CanData %>%
  
  # get the week_year by amnt_per_invoice
  select(week_year, amnt_per_invoice) %>%
  
  # group these data by week year
  group_by(week_year) %>%
  
  # summarize the data by weekly quantity
  summarize(week_amnt_per_inv = sum(amnt_per_invoice)) %>%
  
  # This introduces the lag function, "compute a lagged version of a time 
  # series, shifting the time base back by a given number of observations.
  mutate(prev_week_amnt_per_inv = lag(week_amnt_per_inv, 1)) %>%
  
  # now we get the ratio of the difference between the weekly quantity and 
  # the previous week, and we divide that by the previous week.
  mutate(wow_cost_per_inv = (week_amnt_per_inv - prev_week_amnt_per_inv) / 
                                                     prev_week_amnt_per_inv) %>%
  
  # now we calculate the month, using week_year, abbreviations, and labels
  mutate(month = month(week_year, abbr = TRUE, label = TRUE)) %>%
  
  # finally, we group this final data set by the week_year variable
  group_by(week_year)

# check this data set
WowAmntPerInvoice %>% glimpse()
```

```{r labs_wow_amnt_per_invoice}
  # these are the labels
labs_wow_amnt_per_invoice <- ggplot2::labs(
  y = 'Inoive', 
  x = 'Week', 
  title = 'Week Over Week Amount Per Invoice',
  subtitle = "quantity*unit_price by invoice number",
  caption = "graphic and analysis by PDG") 
```


### Week over week by brand category plot

The data we created above allows us to plot the week over week sales by their brand categories. 

We will plot these data by quarters: 

- Q1 = Oct, Nov, and Dec   
- Q2 = Jan, Feb, and Mar  
- Q3 is Apr, May, and Jun   
- Q4 is Jul, Aug, and Sep  

```{r missing-dec-19-quantity}
knitr::kable(
WeekOverWeek %>% 
  dplyr::filter(month == "Dec") %>% 
  dplyr::select(week_year, 
                wow_quantity))
```

We can see the data are missing for December of 2019. We'll remove this and plot the non-missing data. 

```{r december}
# labels
labs_missing_dec <- ggplot2::labs(
  title = "Week over week sales (December)",
     y = "Week over week quantity",
     x = "Week year")
# plot only December
WeekOverWeek %>% 
  dplyr::filter(month == "Dec" & 
                  !is.na(wow_quantity)) %>% 
    # this will put week_year on the x
    ggplot2::ggplot(aes(x = week_year, 
                        # and the week over week quantity on the y
                        y = wow_quantity)) +
  # add the line plot
    ggplot2::geom_line() +
  # and the point
    ggplot2::geom_point() +
  # the axis title here will inherit the size and color
    ggplot2::theme(axis.title = element_text(face = c("bold"))) +
  # this will remove the legend
    ggplot2::theme(legend.title = element_blank()) +
  # this adds the percent on the y axis
    ggplot2::scale_y_continuous(labels = 
                                  scales::percent_format(accuracy = 1)) + 
  labs_missing_dec
```

## Quantity sold per week

Now we're wondering what the quantity sold per week is, and we can get this with `week_year` and `week_qty`.

```{r ggWowQuantity}
labs_quantity_per_week <- ggplot2::labs(
         x = "Week", 
         y = "Quantity Sold",
         title = "Quantity Per Week") 

ggWowQuantity <- WeekOverWeek %>%
  # drop missing
    tidyr::drop_na() %>%
  # plot week_year on the x
    ggplot2::ggplot(data = ., 
           aes(x = week_year, 
               # and week quantity on the y
               y = week_qty)) + 
  # add the line plot
    ggplot2::geom_line() +
  # add the smooth (predictor)
    ggplot2::geom_smooth() +
  # add points
    ggplot2::geom_point() +
    labs_quantity_per_week
ggWowQuantity
```

These were used in the previous graph:

```r
    stat_summary(fun.y = mean,
                 geom = "bar") +
    stat_summary(fun.data = mean_cl_boot,
                 geom = "errorbar",
                 width = 0.3) +
```

But I opted for the line + points. 

## Create Monthly Sales by Location 

Next we create the monthly sales data frame, with the `unit_price`, `quantity`, `location`, and `floor_month`.

```{r MonthlyLocationSales}
MonthlyLocationSales <- CannabisWowData %>% 
    # get the floor_month. location, quantity, and unit_price
    dplyr::select(floor_month, 
                  location, 
                  quantity,  
                  unit_price) %>%
    # we can create the "sales"
    dplyr::mutate(sales = quantity*unit_price) %>%
    # now we group by the floor_month and location
    dplyr::group_by(floor_month, location) %>%
    # and summarize this by the monthly_sales and median sales
    dplyr::summarize(total_monthly_sales = sum(sales, na.rm = TRUE), 
                     median_monthly_sales = median(sales, na.rm = TRUE)) %>%
    # and group it by the floor_month and location
    dplyr::group_by(floor_month, location) %>% 
    # remove the SP location
    dplyr::filter(location != "SP")
# check new data 
MonthlyLocationSales %>% dplyr::glimpse(78)
```

This gives us a grouped `data.frame` with 138 rows. 

## Total Monthly Sales by Location

This plot will graph the monthly sales of cannabis products by their location (abbreviated). 

```{r ggTop100MonthlyLocationSales}
# labels
labs_monthly_location_sales <- ggplot2::labs(y = 'Total Monthly Sales',
                  x = 'Month',
                  title = 'Total Monthly Sales By Location')

# plot
ggTop100MonthlyLocationSales <- MonthlyLocationSales %>%
    # sort these by total_monthly_sales
    dplyr::arrange(desc(total_monthly_sales)) %>% 
    # plot this as floor_month vs. monthly sales
    ggplot2::ggplot(data = ., 
                    # month
                    aes(x = floor_month, 
                        # total monthly sales here
                        y = total_monthly_sales)) +
    # add a line
    ggplot2::geom_line() +
    # and a point
    ggplot2::geom_point() +
    # and a theme
    ggplot2::theme(axis.title = 
                     element_text()) +   
    # with legend title
    ggplot2::theme(legend.title = 
                     element_blank()) +
    # and the scales for dollar formats
    ggplot2::scale_y_continuous(labels = 
                                  scales::dollar_format(accuracy = 1)) +
    # facet by the location
    ggplot2::facet_wrap(. ~ location, 
                        scales = "free", 
                        ncol = 4) + 
    # adjust the x axis text
    ggplot2::theme(axis.text.x = 
                     element_text(angle = 45, 
                                  hjust = 0.5, 
                                  vjust = 0.5)) +
    # 
    labs_monthly_location_sales
ggTop100MonthlyLocationSales 
```

Faceting by location and having months on the x axis is helpful for spotting trends, but graphs like this can help us spot gaps in total sales by location (i.e. California vs. Manitoba).

## Median Order Sales by Location 

This is the median sales by `floor_month`, sorted by the `median_sales`. 

```{r ggMedianOrderValue, message=FALSE, warning=FALSE}
# labels
labs_median_order_value <- ggplot2::labs(
                  y = 'Median Monthly Sales', 
                  x = 'Floor Month',
                  title = 'Median Monthly Sales by Location')
# plot
ggMedianOrderValue <- MonthlyLocationSales %>%
    # sort these by median_sales
    dplyr::arrange(desc(median_monthly_sales)) %>% 
    # plot
    ggplot2::ggplot(data = ., 
                    # put months on the x 
           mapping = aes(x = floor_month, 
                         # median monthly sales
                         y = median_monthly_sales)) +
    # add the line
    ggplot2::geom_line() +
    # add the point
    ggplot2::geom_point() +
    # add the y format
    ggplot2::scale_y_continuous(labels = 
                                    scales::dollar_format(accuracy = 1)) +
  
    # facet this by the location and set scales to free
    ggplot2::facet_wrap(. ~ location, 
                        scales = "free") + 
  
      # adjust the x axis text
    ggplot2::theme(axis.text.x = 
                     element_text(angle = 45, 
                                  hjust = 0.5, 
                                  vjust = 0.5)) +
  # add the labels
  labs_median_order_value

ggMedianOrderValue
```

## Export 

Time-stamp and export.

```{r export}
# export CannabisWowData -----
write_csv(as.data.frame(CannabisWowData), 
          path = paste0("data/processed/", 
                        base::noquote(lubridate::today()),
                        "-CannabisWowData.csv"))
# export WeekOverWeek -----
write_csv(as.data.frame(WeekOverWeek), 
          path = paste0("data/processed/", 
                        base::noquote(lubridate::today()),
                        "-WeekOverWeek.csv"))

# export MonthlyLocationSales -----
write_csv(as.data.frame(MonthlyLocationSales), 
          path = paste0("data/processed/", 
                        base::noquote(lubridate::today()),
                        "-MonthlyLocationSales.csv"))

write_csv(as.data.frame(Top50Data), 
          path = paste0("data/processed/", 
                        base::noquote(lubridate::today()),
                        "-Top50Data.csv"))

fs::dir_ls("data/processed/", recurse = FALSE)
```

---
title: "CanDash (a minimal cannabis dashboard) v0.0.4"
author: "Martin Frigaard"
output: 
  flexdashboard::flex_dashboard:
    navbar:
      - { title: "Author", href: "https://martinfrigaard.io/" }
    orientation: rows
    social: menu
    css: style.css
runtime: shiny
---

```{r setup, include=FALSE}
# packages ------
library(flexdashboard)
library(shiny)
library(tidyverse)
library(magrittr)
library(plotly)
library(highcharter)
library(viridisLite)
library(treemap)
library(RColorBrewer)
library(ggthemes)
# fs::dir_ls("data/processed/", 
#            regex = "-MonthlyLocationSales")
# import MonthlyLocationSales ------
MonthlyLocationSales <- readr::read_rds("data/processed/2020-04-25-MonthlyLocationSales.rds")
# import BrandCatTop10 ------
BrandCatTop10 <- readr::read_rds("data/processed/2020-04-24-BrandCatTop10.rds")
# import Top10Brands ------
Top10Brands <- readr::read_rds("data/processed/2020-04-24-Top10Brands.rds")
# load the data into the dashboard 
# import WeekOverWeek ------
WeekOverWeek <- readr::read_rds("data/processed/2020-04-21-WeekOverWeek.rds")
# remove missing
WeekOverWeek <- WeekOverWeek %>% tidyr::drop_na()
# import GroupedCanData ------
GroupedCanData <- readr::read_rds("data/processed/2020-04-21-Top100BrandCatsData.rds")
# import Top25Data ----
Top25Data <- readr::read_rds("data/processed/2020-04-21-Top25Data.rds")
```

Column {.sidebar}
-----------------------------------------------------------------------

This is a sample sales dashboard for cannabis products. Select a quarter below to view the sales across a three-month period. 

```{r selector-quarter}
shiny::selectInput(inputId = "quarterNum", 
                   label = h3("Fiscal Quarter"), 
    choices = list("Q1" = 1, "Q2" = 2, "Q3" = 3, "Q4" = 4), 
    selected = 3)

shiny::selectInput(inputId = "locationNum", 
                   label = h3("Sales Region"), 
                   choices = list("West/Pacific" = 1, 
                                  "West/Mountain" = 2), 
                   selected = 1)
```

These data come from the UK e-commerce dataset from the [UCI Machine Learning Laboratory](https://archive.ics.uci.edu/ml/datasets/online+retail) and the [kushy cannabis data set](https://github.com/kushyapp/cannabis-dataset). 

This dashboard was built using [`flexdashboard`](https://rmarkdown.rstudio.com/flexdashboard/). The graphics are built using [`ggplot2`](https://ggplot2.tidyverse.org/), [`plotly`](https://github.com/ropensci/plotly#readme), and [`highcharter`](http://jkunst.com/highcharter/).

**Quantity sold per week**

This graph displays the overall quantity sold per week.

**Week over week sales**

These are the sales by quarter and month. Select the quarter in the sidebar. 

**Contact**

Please contact `mjfrigaard@gmail.com` for more information.

<!--{data-width=600}--> 

Row {.tabset .tabset-fade}
-------------------------------------

### Quantity sold per week

```{r quantity-sold-per-week, eval=TRUE}
# # set theme for wow ----
ggplot2::theme_set(hrbrthemes::theme_ipsum_rc(
  base_family = "Ubuntu",
  base_size = 9,
  strip_text_size = 11,
  axis_title_size = 9,
  plot_title_size = 15,
  subtitle_size = 13
))

# create reactive for quarter ----
WowReact <- reactive({
  # rename this reactive to generic data
        data <- WeekOverWeek %>%
          # remove missing
          tidyr::drop_na()
          # return data
          data
        
    })

# create labs for Quantity Per Week ----
labs_quantity_per_week <- ggplot2::labs(
         x = "Week", 
         y = "Quantity Sold",
         title = "Quantity Per Week") 

# render plot with reactive -----
plotly::renderPlotly({
  
   data <- WowReact()
   
    gg_qpw <- ggplot2::ggplot(data = data, 
                  # put week_year on the x
               aes(x = week_year, 
                   # and week quantity on the y
                   y = week_qty)) + 
      # add the line plot
        ggplot2::geom_line() +
      # add the smooth (predictor)
        ggplot2::geom_smooth() +
      # add points
        ggplot2::geom_point() +
      # add labels
        labs_quantity_per_week
    
    plotly::toWebGL(plotly::ggplotly(gg_qpw))
})
```


### Week over week sales 

```{r wow-plot}
# labels Week Over Week Annual Sales ----
labs_wow_annual_sales <- ggplot2::labs(
  y = 'Sales', 
  x = ' ', 
  title = 'Week Over Week Annual Sales',
  subtitle = "Quarter 3 Simulated Cannabis Sales Data",
  caption = "Graphic and analysis by PDG") 

# create reactive (QDataReact) for quarter data ----
QDataReact <- reactive({
  # rename this reactive to generic data
          # filter this to the selected option from the side-panel
         data <- dplyr::filter(WeekOverWeek, 
                      # set numerical category for numerical quarter variable
                        quar == as.numeric(input$quarterNum))
         
         data
    })

# create session data
cdata <- session$clientData


# render plot with reactive -----
plotly::renderPlotly({
  
   data <- QDataReact()
   
   gg_wow_sales <- data %>% 
  
  # this will put week_year on the x
    ggplot2::ggplot(aes(x = week_year, 
                        # and the week over week quantity on the y
                        y = wow_quantity,
                        # group by month
                        group = month)) +
  # add the line plot
    ggplot2::geom_line(color = "green4",
                       alpha = 0.3,
                       show.legend = FALSE) +
  # and the point
    ggplot2::geom_point(color = "green4", 
                        alpha = 0.7,
                           show.legend = FALSE) +
  # the axis title here will inherit the size and color
    ggplot2::theme(axis.title = element_text(face = c("bold"))) +
  # this will remove the legend
    ggplot2::theme(legend.title = element_blank()) +
  # this adds the percent on the y axis
    ggplot2::scale_y_continuous(labels = 
                                  scales::percent_format(accuracy = 1)) +
  # # here we facet by the month
    ggplot2::facet_wrap(. ~ month,
                        #
                        scales = "free") +
    ggplot2::theme(axis.text.x = 
                     element_text(angle = 45, 
                                  hjust = 0.5, 
                                  vjust = 0.5)) +
           # add theme
    ggthemes::theme_hc(base_size = 10, 
                                   base_family = "Ubuntu") +
    
  labs_wow_annual_sales
   
   # convert to plotly object
    plotly::hide_legend(
      plotly::toWebGL(
        plotly::ggplotly(p = gg_wow_sales, 
                         
                       width = cdata$output_pid_width, 
                       
                       height = cdata$output_pid_height)
        ))
  
})
```

<!-- ### Total Monthly Sales by Location -->

<!-- ```{r ggTop100MonthlyLocationSales} -->
<!-- # labels -->
<!-- labs_monthly_location_sales <- ggplot2::labs(y = 'Total Monthly Sales', -->
<!--                   x = ' ', -->
<!--                   title = 'Total Monthly Sales By Region & Location') -->

<!-- # create reactive (MonLocSalesReac) for Location data ---- -->
<!-- MonLocSalesReac <- reactive({ -->
<!--   # rename this reactive to generic data -->
<!--          data <- dplyr::filter(MonthlyLocationSales, -->
<!--                       # set numerical category for numerical sales region -->
<!--                         sales_reg_num == as.numeric(input$locationNum)) -->
<!--          data -->
<!--     }) -->


<!-- # render plot with reactive ----- -->
<!-- plotly::renderPlotly({ -->

<!--     MonLocSalesReac() %>% -->
<!--     # sort these by total_monthly_sales -->
<!--     dplyr::arrange(desc(total_monthly_sales)) %>% -->
<!--     # plot this as floor_month vs. monthly sales -->
<!--     ggplot2::ggplot(data = ., -->
<!--                     # month -->
<!--                     aes(x = floor_month, -->
<!--                         # total monthly sales here -->
<!--                         y = total_monthly_sales)) + -->
<!--     # add a line -->
<!--     ggplot2::geom_line(aes(color = location), show.legend = FALSE) + -->
<!--     # and a point -->
<!--     ggplot2::geom_point(aes(color = location), show.legend = FALSE) + -->
<!--     # and a theme -->
<!--     ggplot2::theme(axis.title = -->
<!--                      element_text()) + -->
<!--     # with legend title -->
<!--     ggplot2::theme(legend.title = -->
<!--                      element_blank()) + -->
<!--     # and the scales for dollar formats -->
<!--     ggplot2::scale_y_continuous(labels = -->
<!--                                   scales::dollar_format(accuracy = 1)) + -->
<!--     # facet by the sales_region -->
<!--     ggplot2::facet_wrap(location ~ sales_region, -->
<!--                         scales = "free_x") + -->
<!--     # adjust the x axis text -->
<!--     ggplot2::theme(axis.text.x = -->
<!--                      element_text(angle = 45, -->
<!--                                   hjust = 0.5, -->
<!--                                   vjust = 0.5)) + -->
<!--     # add labs -->
<!--     labs_monthly_location_sales -> ggTop100MonthlyLocationSales -->


<!-- # convert to plotly -->
<!-- plotly::hide_legend( -->
<!--   plotly::toWebGL( -->
<!--     plotly::ggplotly(ggTop100MonthlyLocationSales))) -->
<!-- }) -->
<!-- ``` -->



Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Sales by Category

```{r treemap}
# treemap --------
highcharter::hctreemap2(data = GroupedCanData, 
                        
              group_vars = c("brand_category"),
              
              size_var = "sales_by_cat", 
              
              color_var = "sales_by_cat",
              
              layoutAlgorithm = "squarified",
              
              levelIsConstant = FALSE,
              
              allowDrillToNode = TRUE) %>% 
  
  # add the RColorBrewer greens 
  
    hc_colorAxis(minColor = RColorBrewer::brewer.pal(7, "Greens")[1],
                 
                 maxColor = RColorBrewer::brewer.pal(7, "Greens")[7]) 

```

### Best Selling Brand Categories

```{r geom-col-top-10-brand-categories}
# define labels ----
top_10brand_cat_labs <- ggplot2::labs(x = "Brands",
                             
                  y = "Count",
                  
                  title = "Top 10 Cannabis Brands Categories") 

# create session data
cdata <- session$clientData
  
# create BrandCatTop10React reactive ----

BrandCatTop10React <- reactive({
  
  # rename this reactive to generic data
  
        data <- BrandCatTop10
        
          data
        
})

# render plot with reactive -----
plotly::renderPlotly({
  
  data <- BrandCatTop10React()
  
    data %>% 
      
      ggplot2::ggplot(aes(x = brand_category, 
                      y = n)) +
      
    ggplot2::geom_col(aes(fill = brand_category), 
                      show.legend = FALSE) +

    ggplot2::coord_flip() +
      
    ggplot2::theme_minimal(base_size = 10, 
                               
                          base_family = "Ubuntu") +
      
    ggplot2::scale_fill_viridis_d(direction = -1) +
    
    top_10brand_cat_labs -> gg_top10_brand_categories
    
    # convert to plotly object
    plotly::hide_legend(plotly::toWebGL(
      plotly::ggplotly(p = gg_top10_brand_categories)))
    
})
```

### Best Selling Brands

```{r geom-col-top-10-brands}
# define labels ----
top_10brand_labs <- ggplot2::labs(x = "Brands",
                             
                  y = "Count",
                  
                  title = "Top 10 Cannabis Brands") 

# create session data
cdata <- session$clientData
  
# create Top10React reactive ----

Top10React <- reactive({
  
  # rename this reactive to generic data
  
        data <- Top10Brands
        
          data
        
})

# render plot with reactive -----
plotly::renderPlotly({
  
  data <- Top10React()
  
    data %>% 
      
    ggplot2::ggplot(aes(x = brand, 
                      y = n)) +
  
    ggplot2::geom_col(aes(fill = brand), 
                      show.legend = FALSE) +
  

    ggplot2::coord_flip() + 
      
    ggplot2::theme_minimal(base_size = 10, 
                               
                               base_family = "Ubuntu") +
      
    ggplot2::scale_fill_viridis_d(direction = -1) +
      
    top_10brand_labs -> gg_top10_brands
    
    
    
    # convert to plotly object
plotly::hide_legend(plotly::toWebGL(
      plotly::ggplotly(p = gg_top10_brands)))
    
})
```


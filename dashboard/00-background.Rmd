---
title: "Background - building the cannabish board (a shiny cannabis dashboard)"
output: github_document
---

```{r setup, include=FALSE}
# create figs folder ----
if (!file.exists("figs/")) {
    dir.create("figs/")
}
# create data folder ----
if (!file.exists("data/")) {
    dir.create("data/")
}
# create docs folder ----
if (!file.exists("docs/")) {
    dir.create("docs/")
}
library(knitr)
library(rmdformats)
library(tidyverse)
library(devtools)
library(hrbrthemes)
library(inspectdf)
# chunks set options
knitr::opts_chunk$set(
  echo = TRUE, # show/hide all code
  # results = "hide", # hide results
  tidy = FALSE, # cleaner code printing
  comment = "#> ", # better console printing
  eval = TRUE, # turn this to FALSE stop code chunks from running
  message = TRUE, # show messages
  warning = FALSE, # show warnings
  size = "small", # size of the text
  fig.path = "figs/", # location of files
  fig.height = 5.5, # height of figures
  fig.width = 8 # width of figures
) # width of figures
# knit set options
knitr::opts_knit$set(
  width = 78,
  progress = FALSE
)
# base options
base::options(
  tibble.print_max = 25,
  tibble.width = 78,
   max.print = 999999,
  scipen = 100000000
)
```

# Motivation

This document will outline 1) how other applications were built 2) what designs we used, and 3) failed attempts.


## The Wedding Risk Shiny Dashboard

The primary shiny dashboard used for inspiration is from: 

- [this blogpost](https://www.business-science.io/business/2019/06/09/Wedding-Risk-Model-App.html)  

- here is [the deployed application](https://bclark.shinyapps.io/WeddingRiskModel_App/).

- The code for building this application can be found in this [Github repository](https://github.com/bclark86/WeddingRiskModel).

### The landing page (User Interface design)

The UI is in the image below

```{r 00-ui-WeddingRiskModel_App}
knitr::include_graphics(path = "figs/00-ui-WeddingRiskModel_App.png")
```

This shows the general layout and orientation (which is also at the top of the `.Rmd` file of the application).

```yaml
---
title: "Wedding Invitation Risk Modeling"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    source_code: https://github.com/bclark86/WeddingRiskModel
---
```

### The Rmarkdown file (`WeddingRiskModel_App.Rmd`)

This file contains the UI and server for the Shiny application.

```{r global, eval=FALSE}
# other libraries included in source scripts
library(flexdashboard)
# calculate functions are sourced by the simulate file
source("00_Scripts/simulate.R")
source("00_Scripts/plot.R")
```

### The Sidebar

```Rmarkdown

Sidebar {.sidebar}
======================================================================

\```{r}
numericInput("budget", "Total Budget: ", 30000,
  min = 0, max = 1e9,
  step = 100, width = NULL
)

sliderInput("risk_tolerance", "Risk Tolerance: ",
  min = 0, max = 100,
  value = 20, step = 5, post = " %"
)

numericInput("fixed_cost", "Guest Base Cost: ", 22000,
  min = 0, max = 1e9,
  step = 100, width = NULL
)

numericInput("guest_base", "Guest Base Count: ", 50,
  min = 0, max = 1e6,
  step = 1, width = NULL
)

numericInput("var_cost", "Variable Guest Cost: ", 125,
  min = 0, max = 1000,
  step = NA, width = NULL
)

numericInput("invited_guests", "Total Guests Invited: ", 150,
  min = 0, max = 1e6,
  step = NA, width = NULL
)

sliderInput("guest_prob", "Guest Probability to Attend: ",
  min = 0, max = 100,
  value = c(60, 85), step = 5, post = " %"
)

actionButton("run", "Run Model")
\```

```

### Internal components of the dashboard design

This application was built using the `flexdashboard` package. The internal files and folders are listed below:

```bash
├── 00_Images
│   ├── BML-Loop.webp
│   ├── Simple-Build-Measure-Learn-Loop.png
│   ├── app_preview.png
│   ├── bspf.png
│   └── design_thinking_interaction_design.jpg
├── 00_Scripts
│   ├── calculate.R
│   ├── plot.R
│   └── simulate.R
├── 01_Analysis
│   ├── WeddingRiskModel_Detailed_Analysis.Rmd
│   └── WeddingRiskModel_Detailed_Analysis.html
├── README.md
├── WeddingRiskModel-master.Rproj
├── WeddingRiskModel_App.Rmd
└── rsconnect
    └── documents
        └── WeddingRiskModel_App.Rmd
            └── shinyapps.io
                └── bclark
                    └── WeddingRiskModel_App.dcf
```

#### Wedding Risk Model - 00_Images

This folder contains the .png and .jpg files used in this application.

#### Wedding Risk Model - 00_Scripts

There are three scripts in this folder: `calculate.R`, `plot.R`, and `simulate.R`.

##### calculate.R - step 1

This script starts off by creating three functions: `calculate_wedding_cost`, `calculate_risk`, and `calculate_recommendation`.

```{r calculate.R-CALCULATION-FUNCTIONS, eval=TRUE}
# CALCULATION FUNCTIONS ----
# function to calculate total cost
calculate_wedding_cost <- function(fixed_cost, 
                                   variable_guest_cost, 
                                   guest_base, total_guests) {
  # calculate added guest cost
  variable_cost <- variable_guest_cost * (total_guests - guest_base)
  # add to fixed cost
  total_cost <- variable_cost + fixed_cost
  return(total_cost)
}
# function to calculate risk
calculate_risk <- function(budget, total_cost) {
  return(budget - total_cost)
}
# function to recommend action
calculate_recommendation <- function(risk) {
  recommendation <- ifelse(risk >= 0, "Invite All", "Invite Less")
  return(recommendation)
  
}
```

these functions are then used in the `plot.R` and `simluate.R` file.s 

##### plot.R - step 1

This script starts off running a few lines to install the packages.

```{r calculate-packages, eval=TRUE}
library(tidyverse)
library(glue)
```

##### plot.R - step 2

Then a call is made to run the `simulate.R` script, so this is an external dependency. Generally speaking, the `simulate.R` script creates the data for the application.

```{r call-to-simulate.R, eval=FALSE}
# get recommendation function
source("00_Scripts/simulate.R")
```

The `simulate.R` script is described in more depth below. 

#### simulate.R - step 1

This script is called in the second line of the `calculate.R` file, and the first line calls the `calculate.R` script (little redundant, but I can understand that).

```{r simulate.R-in-calculate, eval=FALSE}
library(tidyverse)
source("00_Scripts/calculate.R")
```

This script creates the following objects 

```{r SIMULATION-FUNCTIONS-sample_guests, eval=TRUE}
# SIMULATION FUNCTIONS ----
# function to return a sample of guests for a single trial
sample_guests <- function(n, p) {
  # sum of random sample of size n with prob p of attending
  count <- sum(rbinom(n, 1, p))
}
sample_guests
```

This function is used to create the simluated weddings data frame. 

#### The `simulate_weddings()` function (create data)

This is used to take the application inputs and turn them into a data frame. 

```{r SIMULATION-FUNCTIONS-sample_guests}
# a function to simulate k weddings of n guests with probability p[1] to p[2]
simulate_weddings <- function(k, n, p,fixed_cost, variable_guest_cost, 
                              guest_base, budget) {
  
  total_guests  <- replicate(
    # for k trials...
    k, 
    # sample n guests of probability p_1 to p_2
    sample_guests(n, p = runif(1, min = p[1], max = p[2]))
  )
  
  df <- data.frame(total_guests) %>%
    as.tibble() %>%
    # create number of rows 
    mutate(trial = row_number()) %>%
    # total cost 
    mutate(total_cost = calculate_wedding_cost(fixed_cost, 
                                               variable_guest_cost,
                                               guest_base, 
                                               total_guests)
    # recall the total cost:
    # calculate added guest cost
    # variable_cost <- variable_guest_cost * (total_guests - guest_base)
    # add to fixed cost
    # total_cost <- variable_cost + fixed_cost
    ) %>%
    # total risk
    mutate(risk = calculate_risk(budget, total_cost)) %>%
    # budget indicator
    mutate(over_budget = case_when(
      risk < 0 ~ "Yes",
      risk == 0 ~ "Even",
      risk > 0 ~ "No"),
      # used for coloring risk profile
      over_budget = factor(over_budget, levels = c("No", "Even", "Yes"))
    ) %>%
    # recommendation
    mutate(recommendation = calculate_recommendation(risk)) %>%
    select(trial, everything())
  
  return(df)
}
```

```{r}
simulate_weddings(k = 100, n = 50, 
                  p = 0.1, fixed_cost = 120, 
                  variable_guest_cost = 125, 
                  guest_base = 120, budget = 100) %>% 
                  dplyr::glimpse(78)
```

This goes into the application as `df`.

```{r}
# function to provide recommendation based on simulation outcomes
recommend <- function(simulation_tbl, risk_tolerance) {
  
  # percentage of simulations that go over budget
  risk_pct <- simulation_tbl %>%
    summarize(mean(risk < 0)) %>% 
    pull()
  
  # determine if risk percentage exceeds tolerance
  recommendation <- ifelse(risk_pct > risk_tolerance, "Invite Less", "Invite All")
  
  return(recommendation)
}
```

##### calculate.R - step 3

This creates a theme and color pallete. 

```{r calculate-SETUP, eval=FALSE}
# SETUP ----
# set theme for plots
theme_set(theme_minimal(base_family = "Avenir"))
# The palette with grey:
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
               "#0072B2", "#D55E00", "#CC79A7")

```

And this creates the plot functions.

```{r calculate-PLOT-FUNCTIONS, eval=FALSE}
# PLOT FUNCTIONS ----
# plot guest count distribution with 95% confidence interval
plot_guest_count <- function(simulation_tbl) {
  # generate 2.5 and 97.5 percentiles from simulation data
  ci_int_guest <- quantile(simulation_tbl$total_guests, p = c(0.025, .975))
  # create histogram plot of results
  p <- simulation_tbl %>%
    ggplot(aes(total_guests)) +
    geom_histogram(binwidth = 1, 
                   fill = cbPalette[6],
                   color = "white") +
    geom_hline(yintercept = 0, size = .5, colour="#333333") +
    geom_vline(xintercept = ci_int_guest[1], linetype = "dashed") +
    geom_vline(xintercept = ci_int_guest[2], linetype = "dashed") +
    labs(title = "Total Guest Count",
         subtitle = glue("95% Confidence Estimate: {ci_int_guest[1]} -",
                         "{ci_int_guest[2]} guests"),
         x = "Total Guests",
         y = "Simulation Trials",
         caption = "Source: Simulation Results")
  
  return(p) 
}
# plot cost distribution with 95% confidence interval
plot_cost <- function(simulation_tbl, variable_guest_cost = 125) {
  ci_int_cost <- quantile(simulation_tbl$total_cost, p = c(0.025, .975))
  # create histogram of results
  p <- simulation_tbl %>%
    ggplot(aes(total_cost)) +
    # histogram bin size should be equal to per guest variable cost
    geom_histogram(binwidth = variable_guest_cost,
                   fill = cbPalette[8],
                   color = "white") +
    geom_hline(yintercept = 0, size = .5, colour="#333333") +
    labs(title = "Total Guest Cost",
         subtitle = glue("95% Confidence Estimate: ${ci_int_cost[1]} -",
                         "${ci_int_cost[2]}"),
         x = "Total Cost",
         y = "Simulation Trials",
         caption = "Source: Simulation Results") +
    geom_vline(xintercept = ci_int_cost[1], linetype = "dashed") +
    geom_vline(xintercept = ci_int_cost[2], linetype = "dashed")
  
  return(p)
}
# plot the risk profile with probability of going over budget
plot_risk <- function(simulation_tbl, variable_guest_cost = 125) {
  
  ci_int_risk <- quantile(simulation_tbl$risk, p = c(0.025, .975))
  
  # risk profile
  p_over_budget <- simulation_tbl %>%
    summarise(p_val = mean(risk < 0))
  
  # plot risk profile with 95% confidence interval
  p <- simulation_tbl %>%
    # color histrogram bins based on positive/negative risk
    ggplot(aes(risk, fill = over_budget)) +
    # histogram bin size should be equal to per guest variable cost
    geom_histogram(binwidth = variable_guest_cost,
                   color = "white") +
    geom_hline(yintercept = 0, size = .5, colour = "#333333") +
    scale_fill_manual(values = c(cbPalette[4], cbPalette[5], cbPalette[7])) +
    labs(title = "Total Budget Risk",
         subtitle = glue("95% Confidence Estimate: ${ci_int_risk[1]} - ${ci_int_risk[2]} ",
                         "({p_over_budget * 100}% risk)"),
         x = "Net Risk",
         y = "Simulation Trials",
         caption = "Source: Simulation Results") +
    guides(fill = FALSE) +
    geom_vline(xintercept = ci_int_risk[1], linetype = "dashed") +
    geom_vline(xintercept = ci_int_risk[2], linetype = "dashed")
  
  # if there are no even budget outcomes
  if (length(unique(simulation_tbl$over_budget)) < 3) {
    p <- p +
      scale_fill_manual(values = c(cbPalette[4], cbPalette[7]))
  }
  
  return(p)
}
# plot the distribution of recommendation outcomes
plot_recommendation <- function(simulation_tbl, risk_tolerance) {
  
  # get recommendation for subtitle
  ovr_recommendation <- recommend(simulation_tbl, risk_tolerance)
  
  # build main plot
  p <- simulation_tbl %>%
    ggplot(aes(recommendation, fill = recommendation)) +
    # convert counts to percentages
    geom_bar(aes(y = (..count..) / sum(..count..))) + 
    scale_y_continuous(labels = function(x) glue("{round(x * 100, 2)}%")) +
    labs(
      title = "Recommendation Outcomes",
      subtitle = glue("Overall Recommendation: {ovr_recommendation}"),
      x = "",
      y = "Simulation Trials",
      caption = "Source: Simulation Results"
    ) +
    guides(fill = FALSE) +
    geom_hline(yintercept = 0, size = .5, colour = "#333333") +
    # add dashed line for risk tolernace
    geom_hline(yintercept = risk_tolerance, linetype = "dashed")
  
  # if risk tolerance is exceeded, color the Invite Less bar 
  if (mean(simulation_tbl$risk < 0) >= risk_tolerance) {
    p <- p + 
      scale_fill_manual(values = c(cbPalette[1], cbPalette[7]))
  } else {
    # else color the Invite All bar
    p <- p + 
      scale_fill_manual(values = c(cbPalette[4], cbPalette[1]))
  }
  
  return(p)
}
```


#### Wedding Risk Model - 01_Analysis



## The Specialized Shiny Dashboard

The secondary shiny dashboard used for inspiration is from [this blogpost](https://www.business-science.io/code-tools/2019/10/07/rvest-web-scraping.html) and [this application](https://joon.shinyapps.io/specialized_price_prediction/).

The code for building this application can be found in this [Github repository](https://github.com/joon-im/specialized_price_prediction).

### Internal components of the design

The files in the application repo are displayed in the tree below 

```bash
├── DIN_Next_W01_Regular.ttf
├── README.md
├── SerpentineMediumOblique.ttf
├── how_to_use.png
├── logo.png
├── make_predictions.R
├── model_xgboost.rds
├── preprocess_data.R
├── price_prediction_app.Rmd
├── specialized_bikes_2019.csv
├── specialized_price_prediction-master.Rproj
├── styles-default.css
└── web_scrape.R
```

Starting with the .Rmd document, we will recreate the outline/template.

